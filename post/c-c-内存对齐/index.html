<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="feilengcui008">
<meta name="generator" content="Hugo 0.24.1" />
<title>C/C&#43;&#43;内存对齐</title>
<link rel="shortcut icon" href="https://feilengcui008.github.io/images/favicon.ico">
<link rel="stylesheet" href="https://feilengcui008.github.io/css/style.css">
<link rel="stylesheet" href="https://feilengcui008.github.io/css/main.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/darcula.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  </head>
  <body>
    <nav class="main-nav">

<div class="sidebar-toggle-parent" onmouseover="mouseOver()" onmouseout="mouseOut()">
  <div class="sidebar-toggle sidebar-toggle-0">
      
    <a href="/"><span class="icon icon-home dot"></span></a>
  </div>
  <div class="sidebar-toggle sidebar-toggle-1">
      
    <a href="/categories"><span class="icon icon-archive dot"></span></a>
  </div>
  <div class="sidebar-toggle sidebar-toggle-2">
      
    <a href="/tags"><span class="icon icon-tag dot"></span></a>
  </div>
  <div class="sidebar-toggle sidebar-toggle-3">
      
    <a href="/about"><span class="icon icon-user dot"></span></a>
  </div>
</div>

</nav>

    <section id="wrapper">
        
        
<div class="content content-post CENTER">
  <article id="C/C&#43;&#43;内存对齐" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">C/C&#43;&#43;内存对齐</h1>

    <div class="article-meta">
      <p>
      <span>
        <i class="icon-calendar"></i>
        <span>03-09-2015</span>
      </span>
      </p>
      <span>
        
        <span class="article-meta-span"><a href="/categories/c&#43;&#43;">C&#43;&#43;</a></span>
        
      </span>
      
      <span>
        
      </span>
    </div>
  </header>

  <div class="article-content">
    <p>有时会在c/c++中看到这种形式</p>

<pre><code>#pragma pack(n)
#pragma pack()
</code></pre>

<p>前一句代表设置对齐的字节数为n，而不是编译器默认的对齐字节数（ubuntu 14.04 x86_64下为8），后一句代表恢复默认值，合理地使用内存对齐能减少程序占用的内存空间，使用不当也会降低存取效率从而降低程序性能。在分析内存对齐时，只需要采用以下的原则，这里以一段代码简单解释下</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;


int main()
{
    //缺省，一般8字节对齐
    //struct有成员字节大于pack值,对齐为pack的整数倍=&gt;24
    struct default_pack_struct_size_bigger {
        struct c {
            long long a;
            char d;
        } m;
        char b;
    };
    printf(&quot;default_pack_struct_size_bigger:%d\n&quot;,(int)sizeof(struct default_pack_struct_size_bigger));
    //struct成员字节数都小于pack,按字节数最大的对齐=&gt;4
    struct default_pack_struct_size_smaller {
        char a;
        short int b;
    };
    printf(&quot;default_pack_struct_size_smaller:%d\n&quot;,(int)sizeof(struct default_pack_struct_size_smaller));

    
    //设置pack为4
    #pragma pack(4)
    //结构成员有大于4字节的 =&gt; 12
    struct pack_4_struct_size_bigger {
        unsigned short int a;
        long long b;
    };
    printf(&quot;pack_4_struct_size_bigger:%d\n&quot;,(int)sizeof(struct pack_4_struct_size_bigger));
    //结构成员都小于4字节 =&gt; 4 
    struct pack_4_struct_size_smaller {
        char a;
        unsigned short int b;
    };
    printf(&quot;pack_4_struct_size_smaller:%d\n&quot;,(int)sizeof(struct pack_4_struct_size_smaller));
    #pragma pack()

    return 0;
}
</code></pre>

<p>结果：
<img src="http://img.blog.csdn.net/20150309153751330" alt="" /></p>

<hr />

<p>另外，在对位域操作时有位序的概念，对于小端的机器(通常x86都是)来说，位序与端序是一致的，即对于低位放在高内存地址(当然这个是假定的一个字节内的高位，内存寻址一般是以字节为单位的)</p>

<p>下面是一段测试程序:</p>

<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;


typedef struct {
  int a;  // lower linear address
  char b;  // higher linear address 
} testStruct;

void testStructEndian()
{
  testStruct t = {1, 2};
  fprintf(stdout, &quot;sizeof testStruct : %ld\n&quot;, sizeof(testStruct));
  fprintf(stdout, &quot;%p\n&quot;, &amp;t.a);
  fprintf(stdout, &quot;%p\n&quot;, &amp;t.b);
}

void testInt()
{
  int a = 0x12345678;
  fprintf(stdout, &quot;%x\n&quot;, a);
}


// 小端情况下，对于位域和字节一样也是低线性地址存放内容二进制的低位
// 测试下大端的情况?
typedef struct {
  int a:5;  // lower 
  int b:2;  // higher 
  //int c:10;
} bitField;

void testBitField()
{
  bitField b;
  fprintf(stdout, &quot;sizeof bitField:%ld\n&quot;, sizeof(bitField));
  const char *str = &quot;0123&quot;;
  int temp;
  memcpy(&amp;temp, str, sizeof(int));
  fprintf(stdout, &quot;%x\n&quot;, temp);
  memcpy(&amp;b, str, sizeof(b));  
  fprintf(stdout, &quot;a:%d,b:%d\n&quot;, b.a, b.b);
}

// 0 : little endian
// 1 : big endian
int checkEndian()
{
  union {
    int a;
    char b;
  } u;
  u.a = 1;
  return u.b == 1 ? 0 : 1;
}

int main(int argc, char *argv[])
{
  testStructEndian();
  testInt();
  testBitField();
  fprintf(stdout, &quot;endian:%d\n&quot;, checkEndian());
  return 0;
}
</code></pre>

<p>输出:</p>

<pre><code>sizeof testStruct : 8
0x7fff2d59d790
0x7fff2d59d794
12345678
sizeof bitField:4
33323130
a:-16,b:1
endian:0
</code></pre>

  </div>
</article>

</div>
<div class="fexo-comments comments-post">
  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'feilengcui008';
    var disqus_identifier = 'https:\/\/feilengcui008.github.io\/post\/c-c-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90\/';
    var disqus_title = 'C\/C\x2b\x2b内存对齐';
    var disqus_url = 'https:\/\/feilengcui008.github.io\/post\/c-c-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div> 



        <footer id="footer">
</footer>

    </section>
    <script src="https://feilengcui008.github.io/js/scroll-spy.js"></script>
<script src="https://feilengcui008.github.io/js/head.js"></script>
<script src="https://feilengcui008.github.io/js/bundle.js"></script>
<script src="https://feilengcui008.github.io/js/fastclick.js"></script>
<script src="https://feilengcui008.github.io/js/util.js"></script>
<script src="https://feilengcui008.github.io/js/zenscroll.js"></script>
<script src="https://feilengcui008.github.io/js/app.js"></script>



  </body>
</html>
