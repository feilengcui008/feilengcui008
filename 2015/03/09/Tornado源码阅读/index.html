<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title> Tornado源码阅读 | feilengcui008</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Python,Tornado,Web," />
  

  <meta name="description" content="一、官方实例博客源码官方blog实例，此处摘抄了main函数部分
12345678910111213141516def main():    tornado.options.parse_command_line()	http_server=tornado.httpserver.HTTPServer(Application())    #listen()函数是核心，他做的事情有：    #(1)调用">
<meta property="og:type" content="article">
<meta property="og:title" content=" Tornado源码阅读">
<meta property="og:url" content="/2015/03/09/Tornado源码阅读/index.html">
<meta property="og:site_name" content="feilengcui008">
<meta property="og:description" content="一、官方实例博客源码官方blog实例，此处摘抄了main函数部分
12345678910111213141516def main():    tornado.options.parse_command_line()	http_server=tornado.httpserver.HTTPServer(Application())    #listen()函数是核心，他做的事情有：    #(1)调用">
<meta property="og:updated_time" content="2017-04-01T09:24:35.427Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content=" Tornado源码阅读">
<meta name="twitter:description" content="一、官方实例博客源码官方blog实例，此处摘抄了main函数部分
12345678910111213141516def main():    tornado.options.parse_command_line()	http_server=tornado.httpserver.HTTPServer(Application())    #listen()函数是核心，他做的事情有：    #(1)调用">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css" type="text/css">
  

  

  

  


  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>

  <div class="sidebar-toggle">
  <a href="/"><span class="hfont">H</span></a>
</div>


  

  <!--
<div class="post-header">
   

</div>
-->


  <div id="toc" class="toc-article">
    <strong class="toc-title">Posts List</strong>
    <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#u4E00_u3001_u5B98_u65B9_u5B9E_u4F8B_u535A_u5BA2_u6E90_u7801"><span class="toc-text">一、官方实例博客源码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4E8C_u3001_u8BE6_u7EC6_u5206_u89E3main_28_29"><span class="toc-text">二、详细分解main()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4E09_u3001http_server-listen_28options-port_29_u8BE6_u89E3"><span class="toc-text">三、http_server.listen(options.port)详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u56DB_u3001handle_connection_u54CD_u5E94_u8BF7_u6C42_u5F00_u59CB"><span class="toc-text">四、handle_connection响应请求开始</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4E94_u3001application_u7684call_u5B8C_u6210_u6700_u7EC8_u76F8_u5E94_3A"><span class="toc-text">五、application的call完成最终相应:</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#u8C03_u7528_u7684_when_complete_u56DE_u8C03callback_uFF0C_u4E5F_u5C31_u662F_execute_method"><span class="toc-text">调用的_when_complete回调callback，也就是_execute_method</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u516D_u3001_u603B_u7ED3"><span class="toc-text">六、总结</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Tornado源码阅读" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title"> Tornado源码阅读</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2015.03.09</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>feilengcui008</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/编程语言/">编程语言</a> / <a class="article-category-link" href="/categories/编程语言/Web/">Web</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
        <i class="icon-comment"></i> 
        <span class="ds-thread-count" data-thread-key="post-Tornado源码阅读"><i class="fa fa-spinner fa-spin"></i></span> 条评论
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h4 id="u4E00_u3001_u5B98_u65B9_u5B9E_u4F8B_u535A_u5BA2_u6E90_u7801"><a href="#u4E00_u3001_u5B98_u65B9_u5B9E_u4F8B_u535A_u5BA2_u6E90_u7801" class="headerlink" title="一、官方实例博客源码"></a>一、官方实例博客源码</h4><p><a href="https://github.com/tornadoweb/tornado/tree/master/demos/blog" target="_blank" rel="external">官方blog实例</a>，此处摘抄了main函数部分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    tornado.options.parse_command_line()</span><br><span class="line">	http_server=tornado.httpserver.HTTPServer(Application())</span><br><span class="line">    <span class="comment">#listen()函数是核心，他做的事情有：</span></span><br><span class="line">    <span class="comment">#(1)调用netutil中的bind_socket，返回的是绑定的所有IP地址的 socket</span></span><br><span class="line">    <span class="comment">#(2)通过add_socket方法调用netutil中的add_accept_handler方法，将建</span></span><br><span class="line">    <span class="comment">#   立的连接的回调处理函数_handle_connection添加到ioloop中</span></span><br><span class="line">    <span class="comment">#(3)_handle_connection将handle_stream包装，实质是生成iostream，调</span></span><br><span class="line">    <span class="comment">#   用self.handle_stream()，handle_stream在HTTPServer中重新定义了,</span></span><br><span class="line">    <span class="comment">#   实则用HTTPConnection处理stream，将HTTPConnection对象传入</span></span><br><span class="line">    <span class="comment">#   application的__call__方法中，__call__方法负责完成响应。</span></span><br><span class="line">    <span class="comment">#ioloop的start就是循环判断添加的handler队列是否可以处理，若可以，则调用_handle_connection处理。</span></span><br><span class="line">    http_server.listen(options.port)</span><br><span class="line">    tornado.ioloop.IOLoop.instance().start()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>如上红色部分注释就是一个基本的流程。下面进入详细分析</p>
<h4 id="u4E8C_u3001_u8BE6_u7EC6_u5206_u89E3main_28_29"><a href="#u4E8C_u3001_u8BE6_u7EC6_u5206_u89E3main_28_29" class="headerlink" title="二、详细分解main()"></a>二、详细分解main()</h4><p>前面的设置与handler实例暂时不看，直接从main()函数出发</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def <span class="function"><span class="title">main</span><span class="params">()</span></span>:</span><br><span class="line">    ##解析命令行参数</span><br><span class="line">    tornado<span class="class">.options</span><span class="class">.parse_command_line</span>()</span><br><span class="line">    #构造一个httpserver，其实大部分都是继承至tcpserver，注意参数 <span class="function"><span class="title">Application</span><span class="params">()</span></span></span><br><span class="line">    #是个对象，而且是个可调用的对象，它里面有个方法__call__起了核心作用</span><br><span class="line">    http_server=tornado<span class="class">.httpserver</span><span class="class">.HTTPServer</span>(<span class="function"><span class="title">Application</span><span class="params">()</span></span>)</span><br><span class="line">    </span><br><span class="line">    http_server.<span class="function"><span class="title">listen</span><span class="params">(options.port)</span></span></span><br><span class="line"></span><br><span class="line">    ##构造事件循环，并执行触发事件的相应handler/注册的timeout事件/注册的callback等。</span><br><span class="line">    tornado<span class="class">.ioloop</span><span class="class">.IOLoop</span><span class="class">.instance</span>().<span class="function"><span class="title">start</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<h4 id="u4E09_u3001http_server-listen_28options-port_29_u8BE6_u89E3"><a href="#u4E09_u3001http_server-listen_28options-port_29_u8BE6_u89E3" class="headerlink" title="三、http_server.listen(options.port)详解"></a>三、http_server.listen(options.port)详解</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listen</span><span class="params">(self, port, address=<span class="string">""</span>)</span>:</span></span><br><span class="line">        <span class="comment">##调用netutil中的bind_socket，返回的是绑定的所有(IP,port)地址的socket</span></span><br><span class="line">        sockets = bind_sockets(port, address=address)</span><br><span class="line">        <span class="comment">##自身的add_sockets方法中调用了netutil中的add_accept_handler</span></span><br><span class="line">        self.add_sockets(sockets)</span><br></pre></td></tr></table></figure>
<p>   看看add_sockets干了什么：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_sockets</span><span class="params">(self, sockets)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.io_loop <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            self.io_loop = IOLoop.current()</span><br><span class="line">        <span class="keyword">for</span> sock <span class="keyword">in</span> sockets:</span><br><span class="line">            self._sockets[sock.fileno()] = sock</span><br><span class="line">               </span><br><span class="line">   <span class="comment">#这里回调的是_handle_connection，是处理请求的核心，稍后还会回头看</span></span><br><span class="line">   <span class="comment">#add_accept_handler(sock,self._handle_connection,io_loop=self.io_loop)</span></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_accept_handler</span><span class="params">(sock, callback, io_loop=None)</span>:</span></span><br><span class="line">      <span class="keyword">if</span> io_loop <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">         io_loop = IOLoop.current()</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">accept_handler</span><span class="params">(fd, events)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                connection, address = sock.accept()</span><br><span class="line">            <span class="keyword">except</span> socket.error <span class="keyword">as</span> e:</span><br><span class="line">           </span><br><span class="line">                <span class="keyword">if</span> e.args[<span class="number">0</span>] == errno.ECONNABORTED:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            callback(connection, address)</span><br><span class="line">     <span class="comment">#把callback，也就是_handle_connection这个回调的handler注册到ioloop</span></span><br><span class="line">     <span class="comment">#的多路复用(select/poll/epoll等)之上</span></span><br><span class="line">     io_loop.add_handler(sock.fileno(), accept_handler, IOLoop.READ)</span><br><span class="line">     <span class="comment">#ioloop.add_handler函数:</span></span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">add_handler</span><span class="params">(self, fd, handler, events)</span>:</span></span><br><span class="line">        self._handlers[fd] = stack_context.wrap(handler)</span><br><span class="line">        self._impl.register(fd, events | self.ERROR)</span><br><span class="line">     <span class="comment">#之后就由ioloop.start内的循环poll发生的事件并回调相应的handler了</span></span><br></pre></td></tr></table></figure>
<h4 id="u56DB_u3001handle_connection_u54CD_u5E94_u8BF7_u6C42_u5F00_u59CB"><a href="#u56DB_u3001handle_connection_u54CD_u5E94_u8BF7_u6C42_u5F00_u59CB" class="headerlink" title="四、handle_connection响应请求开始"></a>四、handle_connection响应请求开始</h4><p> 这个函数位于tcpserver中：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">def _handle_connection(self, connection, address):</span><br><span class="line">        <span class="keyword">if</span> self<span class="class">.ssl_options</span> is not None:</span><br><span class="line">            assert ssl, <span class="string">"Python 2.6+ and OpenSSL required for SSL"</span></span><br><span class="line">            try:</span><br><span class="line">                connection = ssl_wrap_socket(connection,</span><br><span class="line">                                             self<span class="class">.ssl_options</span>,</span><br><span class="line">                                             server_side=True,</span><br><span class="line">                                             do_handshake_on_connect=False)</span><br><span class="line">            except ssl<span class="class">.SSLError</span> as err:</span><br><span class="line">                <span class="keyword">if</span> err<span class="class">.args</span>[<span class="number">0</span>] == ssl<span class="class">.SSL_ERROR_EOF</span>:</span><br><span class="line">                    return connection.<span class="function"><span class="title">close</span><span class="params">()</span></span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    raise</span><br><span class="line">            except socket<span class="class">.error</span> as err:</span><br><span class="line">                <span class="keyword">if</span> <span class="function"><span class="title">errno_from_exception</span><span class="params">(err)</span></span> <span class="keyword">in</span> (errno<span class="class">.ECONNABORTED</span>, errno.EINVAL):</span><br><span class="line">                    return connection.<span class="function"><span class="title">close</span><span class="params">()</span></span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    raise</span><br><span class="line">        try:</span><br><span class="line">            <span class="keyword">if</span> self<span class="class">.ssl_options</span> is not None:</span><br><span class="line">                stream = SSLIOStream(connection, io_loop=self<span class="class">.io_loop</span>,</span><br><span class="line">                                     max_buffer_size=self<span class="class">.max_buffer_size</span>,</span><br><span class="line">                                     read_chunk_size=self.read_chunk_size)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                stream = IOStream(connection, io_loop=self<span class="class">.io_loop</span>,</span><br><span class="line">                                  max_buffer_size=self<span class="class">.max_buffer_size</span>,</span><br><span class="line">                                  read_chunk_size=self.read_chunk_size)</span><br><span class="line">            self.<span class="function"><span class="title">handle_stream</span><span class="params">(stream, address)</span></span></span><br><span class="line">        except Exception:</span><br><span class="line">            app_log.<span class="function"><span class="title">error</span><span class="params">(<span class="string">"Error in connection callback"</span>, exc_info=True)</span></span></span><br></pre></td></tr></table></figure>
<p>实例化了iostream对象，这个对象专门负责读写数据。然后是调用heepserver重写的handle_stream方法,<br>将stream交给HTTPConnection处理，注意这里的request_callback是Application对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_stream</span><span class="params">(self, stream, address)</span>:</span></span><br><span class="line">        HTTPConnection(stream, address, self.request_callback,</span><br><span class="line">                       self.no_keep_alive, self.xheaders, self.protocol)</span><br></pre></td></tr></table></figure>
<p>之后就到HTTPConnection初始化部分，核心就是_on_headers方法与read_until</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, stream, address, request_callback, no_keep_alive=False,</span><br><span class="line">                 xheaders=False, protocol=None)</span>:</span></span><br><span class="line">      </span><br><span class="line">        self._header_callback = stack_context.wrap(self._on_headers)</span><br><span class="line">        self.stream.set_close_callback(self._on_connection_close)</span><br><span class="line"></span><br><span class="line">        <span class="comment">##read_until可以暂时简单看作将数据读给_on_headers方法</span></span><br><span class="line">        self.stream.read_until(<span class="string">b"\r\n\r\n"</span>,self._header_callback)</span><br><span class="line"></span><br><span class="line"><span class="comment">##self.request_callback(self._request)，这是调用Application的__call__方法，传入request对象完成响应</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_on_headers</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = native_str(data.decode(<span class="string">'latin1'</span>))</span><br><span class="line">            eol = data.find(<span class="string">"\r\n"</span>)</span><br><span class="line">            start_line = data[:eol]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                method, uri, version = start_line.split(<span class="string">" "</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">raise</span> _BadRequestException(<span class="string">"Malformed HTTP request line"</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> version.startswith(<span class="string">"HTTP/"</span>):</span><br><span class="line">                <span class="keyword">raise</span> _BadRequestException(<span class="string">"Malformed HTTP version in HTTP Request-Line"</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                headers = httputil.HTTPHeaders.parse(data[eol:])</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="comment"># Probably from split() if there was no ':' in the line</span></span><br><span class="line">                <span class="keyword">raise</span> _BadRequestException(<span class="string">"Malformed HTTP headers"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># HTTPRequest wants an IP, not a full socket address</span></span><br><span class="line">            <span class="keyword">if</span> self.address_family <span class="keyword">in</span> (socket.AF_INET, socket.AF_INET6):</span><br><span class="line">                remote_ip = self.address[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># Unix (or other) socket; fake the remote address</span></span><br><span class="line">                remote_ip = <span class="string">'0.0.0.0'</span></span><br><span class="line"></span><br><span class="line">            self._request = HTTPRequest(</span><br><span class="line">                connection=self, method=method, uri=uri, version=version,</span><br><span class="line">                headers=headers, remote_ip=remote_ip, protocol=self.protocol)</span><br><span class="line"></span><br><span class="line">            content_length = headers.get(<span class="string">"Content-Length"</span>)</span><br><span class="line">            <span class="keyword">if</span> content_length:</span><br><span class="line">                content_length = int(content_length)</span><br><span class="line">                <span class="keyword">if</span> content_length &gt; self.stream.max_buffer_size:</span><br><span class="line">                    <span class="keyword">raise</span> _BadRequestException(<span class="string">"Content-Length too long"</span>)</span><br><span class="line">                <span class="keyword">if</span> headers.get(<span class="string">"Expect"</span>) == <span class="string">"100-continue"</span>:</span><br><span class="line">                    self.stream.write(<span class="string">b"HTTP/1.1 100 (Continue)\r\n\r\n"</span>)</span><br><span class="line">                self.stream.read_bytes(content_length, self._on_request_body)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            self.request_callback(self._request)</span><br><span class="line">        <span class="keyword">except</span> _BadRequestException <span class="keyword">as</span> e:</span><br><span class="line">            gen_log.info(<span class="string">"Malformed HTTP request from %s: %s"</span>,</span><br><span class="line">                         self.address[<span class="number">0</span>], e)</span><br><span class="line">            self.close()</span><br><span class="line">            <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<h4 id="u4E94_u3001application_u7684call_u5B8C_u6210_u6700_u7EC8_u76F8_u5E94_3A"><a href="#u4E94_u3001application_u7684call_u5B8C_u6210_u6700_u7EC8_u76F8_u5E94_3A" class="headerlink" title="五、application的call完成最终相应:"></a>五、application的<strong>call</strong>完成最终相应:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">"""Called by HTTPServer to execute the request."""</span></span><br><span class="line">        transforms = [t(request) <span class="keyword">for</span> t <span class="keyword">in</span> self.transforms]</span><br><span class="line">        handler = <span class="keyword">None</span></span><br><span class="line">        args = []</span><br><span class="line">        kwargs = &#123;&#125;</span><br><span class="line">        handlers = self._get_host_handlers(request)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> handlers:</span><br><span class="line">            handler = RedirectHandler(</span><br><span class="line">                self, request, url=<span class="string">"http://"</span> + self.default_host + <span class="string">"/"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> spec <span class="keyword">in</span> handlers:</span><br><span class="line">                match = spec.regex.match(request.path)</span><br><span class="line">                <span class="keyword">if</span> match:</span><br><span class="line">                    handler = spec.handler_class(self, request, **spec.kwargs)</span><br><span class="line">                    <span class="keyword">if</span> spec.regex.groups:</span><br><span class="line">                        <span class="comment"># None-safe wrapper around url_ to handle</span></span><br><span class="line">                        <span class="comment"># unmatched optional groups correctly</span></span><br><span class="line">                        <span class="function"><span class="keyword">def</span> <span class="title">unquote</span><span class="params">(s)</span>:</span></span><br><span class="line">                            <span class="keyword">if</span> s <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                                <span class="keyword">return</span> s</span><br><span class="line">                            <span class="keyword">return</span> escape.url_(s, encoding=<span class="keyword">None</span>,</span><br><span class="line">                                                       plus=<span class="keyword">False</span>)</span><br><span class="line">                        <span class="comment"># Pass matched groups to the handler.  Since</span></span><br><span class="line">                        <span class="comment"># match.groups() includes both named and unnamed groups,</span></span><br><span class="line">                        <span class="comment"># we want to use either groups or groupdict but not both.</span></span><br><span class="line">                        <span class="comment"># Note that args are passed as bytes so the handler can</span></span><br><span class="line">                        <span class="comment"># decide what encoding to use.</span></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> spec.regex.groupindex:</span><br><span class="line">                            kwargs = dict(</span><br><span class="line">                                (str(k), unquote(v))</span><br><span class="line">                                <span class="keyword">for</span> (k, v) <span class="keyword">in</span> match.groupdict().items())</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            args = [unquote(s) <span class="keyword">for</span> s <span class="keyword">in</span> match.groups()]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> handler:</span><br><span class="line">                handler = ErrorHandler(self, request, status_code=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># In debug mode, re-compile templates and reload static files on every</span></span><br><span class="line">        <span class="comment"># request so you don't need to restart to see changes</span></span><br><span class="line">        <span class="keyword">if</span> self.settings.get(<span class="string">"debug"</span>):</span><br><span class="line">            <span class="keyword">with</span> RequestHandler._template_loader_lock:</span><br><span class="line">                <span class="keyword">for</span> loader <span class="keyword">in</span> RequestHandler._template_loaders.values():</span><br><span class="line">                    loader.reset()</span><br><span class="line">            StaticFileHandler.reset()</span><br><span class="line"></span><br><span class="line">        handler._execute(transforms, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> handler</span><br></pre></td></tr></table></figure>
<p>handler._execute(transforms, <em>args, *</em>kwargs)定义在RequestHandler中</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def _execute(self, transforms, *args, **kwargs):</span><br><span class="line">        <span class="string">""</span><span class="string">"Executes this request with the given output transforms."</span><span class="string">""</span></span><br><span class="line">        self._transforms = transforms</span><br><span class="line">        try:</span><br><span class="line">            <span class="keyword">if</span> self<span class="class">.request</span><span class="class">.method</span> not <span class="keyword">in</span> self<span class="class">.SUPPORTED_METHODS</span>:</span><br><span class="line">                raise <span class="function"><span class="title">HTTPError</span><span class="params">(<span class="number">405</span>)</span></span></span><br><span class="line">            self<span class="class">.path_args</span> = [self.<span class="function"><span class="title">decode_argument</span><span class="params">(arg)</span></span> <span class="keyword">for</span> arg <span class="keyword">in</span> args]</span><br><span class="line">            self<span class="class">.path_kwargs</span> = <span class="function"><span class="title">dict</span><span class="params">((k, self.decode_argument(v, name=k)</span></span>)</span><br><span class="line">                                    <span class="keyword">for</span> (k, v) <span class="keyword">in</span> kwargs.<span class="function"><span class="title">items</span><span class="params">()</span></span>)</span><br><span class="line">            <span class="keyword">if</span> self<span class="class">.request</span><span class="class">.method</span> not <span class="keyword">in</span> (<span class="string">"GET"</span>, <span class="string">"HEAD"</span>, <span class="string">"OPTIONS"</span>) and \</span><br><span class="line">                    self<span class="class">.application</span><span class="class">.settings</span><span class="class">.get</span>(<span class="string">"xsrf_cookies"</span>):</span><br><span class="line">                self.<span class="function"><span class="title">check_xsrf_cookie</span><span class="params">()</span></span></span><br><span class="line">            self._when_complete(self.<span class="function"><span class="title">prepare</span><span class="params">()</span></span>, self._execute_method)<span class="comment">//prepare是空的，没被重写</span></span><br><span class="line">        except Exception as e:</span><br><span class="line">            self._handle_request_exception(e)</span><br></pre></td></tr></table></figure>
<h6 id="u8C03_u7528_u7684_when_complete_u56DE_u8C03callback_uFF0C_u4E5F_u5C31_u662F_execute_method"><a href="#u8C03_u7528_u7684_when_complete_u56DE_u8C03callback_uFF0C_u4E5F_u5C31_u662F_execute_method" class="headerlink" title="调用的_when_complete回调callback，也就是_execute_method"></a>调用的_when_complete回调callback，也就是_execute_method</h6><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def _when_complete(self, <span class="literal">result</span>, callback):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="literal">result</span> <span class="keyword">is</span> <span class="type">None</span>:</span><br><span class="line">                callback()</span><br><span class="line">            <span class="keyword">elif</span> isinstance(<span class="literal">result</span>, <span class="type">Future</span>):</span><br><span class="line">                <span class="keyword">if</span> <span class="literal">result</span>.done():</span><br><span class="line">                    <span class="keyword">if</span> <span class="literal">result</span>.<span class="literal">result</span>() <span class="keyword">is</span> <span class="keyword">not</span> <span class="type">None</span>:</span><br><span class="line">                        <span class="keyword">raise</span> <span class="type">ValueError</span>('<span class="type">Expected</span> <span class="type">None</span>, got %r' % <span class="literal">result</span>)</span><br><span class="line">                    callback()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> <span class="type">IOLoop</span></span><br><span class="line">                    <span class="type">IOLoop</span>.current().add_future(</span><br><span class="line">                        <span class="literal">result</span>, functools.partial(self._when_complete,</span><br><span class="line">                                                  callback=callback))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> <span class="type">ValueError</span>(<span class="string">"Expected Future or None, got %r"</span> % <span class="literal">result</span>)</span><br><span class="line">        <span class="keyword">except</span> <span class="type">Exception</span> <span class="keyword">as</span> e:</span><br><span class="line">            self._handle_request_exception(e)</span><br></pre></td></tr></table></figure>
<p>之后是_execute_method </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_execute_method</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._finished:</span><br><span class="line">            method = getattr(self, self.request.method.lower())</span><br><span class="line">          <span class="comment">####当method被执行过后，就直接调用finish，否则将method加入ioloop</span></span><br><span class="line">            self._when_complete(method(*self.path_args, **self.path_kwargs),</span><br><span class="line">                                self._execute_finish)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_execute_finish</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self._auto_finish <span class="keyword">and</span> <span class="keyword">not</span> self._finished:</span><br><span class="line">            self.finish()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finish</span><span class="params">(self, chunk=None)</span>:</span></span><br><span class="line">        <span class="string">"""Finishes this response, ending the HTTP request."""</span></span><br><span class="line">        <span class="keyword">if</span> self._finished:</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">"finish() called twice.  May be caused "</span></span><br><span class="line">                               <span class="string">"by using async operations without the "</span></span><br><span class="line">                               <span class="string">"@asynchronous decorator."</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> chunk <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">            self.write(chunk)</span><br></pre></td></tr></table></figure>
<h4 id="u516D_u3001_u603B_u7ED3"><a href="#u516D_u3001_u603B_u7ED3" class="headerlink" title="六、总结"></a>六、总结</h4><p>至此，整个IO流程完毕，中间还有许多非常值得深入挖掘的地方，比如ioloop/iostream，future，<br>异步客户端，web框架…在网络编程模型方面，是一个很完整的单线程epoll-level trigger-nonblocking<br>的reactor模型，在异步读写等方面的封装值得细看。</p>

    
  </div>
</article>


   

   



</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">Close</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/"
              rel="noopener noreferrer"
              target="_self"
              >
              Home
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              Archives
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              About
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-Tornado源码阅读" 
      data-title=" Tornado源码阅读" data-url="/2015/03/09/Tornado源码阅读/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"feilengcui008"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
