<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>Linux下ELF文件格式 | feilengcui008</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="C/C++,Linux编程," />
  

  <meta name="description" content="In this article,I will talk about the ELF files for Linux,and their diffs as to comprehend the linking process in a diff view angle.There are many articles talking about that topic in the way of compi">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux下ELF文件格式">
<meta property="og:url" content="/2015/09/13/Linux下ELF文件格式/index.html">
<meta property="og:site_name" content="feilengcui008">
<meta property="og:description" content="In this article,I will talk about the ELF files for Linux,and their diffs as to comprehend the linking process in a diff view angle.There are many articles talking about that topic in the way of compi">
<meta property="og:image" content="http://img.blog.csdn.net/20150420101332687">
<meta property="og:image" content="http://img.blog.csdn.net/20150420103046089">
<meta property="og:image" content="http://img.blog.csdn.net/20150420103102329">
<meta property="og:image" content="http://img.blog.csdn.net/20150420103231405">
<meta property="og:image" content="http://img.blog.csdn.net/20150420123100072">
<meta property="og:image" content="http://img.blog.csdn.net/20150420123311384">
<meta property="og:image" content="http://img.blog.csdn.net/20150420123332990">
<meta property="og:image" content="http://img.blog.csdn.net/20150420123344768">
<meta property="og:image" content="http://img.blog.csdn.net/20150420123311721">
<meta property="og:image" content="http://img.blog.csdn.net/20150420125657897">
<meta property="og:image" content="http://img.blog.csdn.net/20150420125723482">
<meta property="og:image" content="http://img.blog.csdn.net/20150420125621933">
<meta property="og:image" content="http://img.blog.csdn.net/20150420130748465">
<meta property="og:image" content="http://img.blog.csdn.net/20150420135821837">
<meta property="og:updated_time" content="2017-04-01T09:24:35.427Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux下ELF文件格式">
<meta name="twitter:description" content="In this article,I will talk about the ELF files for Linux,and their diffs as to comprehend the linking process in a diff view angle.There are many articles talking about that topic in the way of compi">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css" type="text/css">
  

  

  

  


  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>

  <div class="sidebar-toggle-parent">
  <div class="sidebar-toggle">
    <a href="/"><span class="hfont">H</span></a>
  </div>
</div>


  

  <!--
<div class="post-header">
   

</div>
-->


  <div id="toc" class="toc-article">
    <strong class="toc-title">Posts List</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-file_headers"><span class="toc-text">1.file headers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#executable_file_headers_3A"><span class="toc-text">executable file headers:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#object_file_headers_3A"><span class="toc-text">object file headers:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shared_object_file_headers_3A"><span class="toc-text">shared object file headers:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-section_header_table"><span class="toc-text">2.section header table</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exec_file_section_header_table_3A"><span class="toc-text">exec file section header table:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#so_file_section_header_table_3A"><span class="toc-text">.so file section header table:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#o_file_section_header_table_3A"><span class="toc-text">.o file section header table:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-program_header_table"><span class="toc-text">3.program header table</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exec_file_program_header_3A"><span class="toc-text">exec file program header:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#so_file_program_header_3A"><span class="toc-text">.so file program header:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#o_file_program_header_3A"><span class="toc-text">.o file program header:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-common_sections_explain"><span class="toc-text">4.common sections explain</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#The_sections_contain_important_data_for_linking_and_relocation__2C_while_segments_contain_information_that_is_necessary_for_runtime_execution_of_the_file"><span class="toc-text">The sections contain important data for linking and relocation , while segments contain information that is necessary for runtime execution of the file.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-code_mapped_into_sections"><span class="toc-text">5.code mapped into sections</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6_to_the_end"><span class="toc-text">6 to the end</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Linux下ELF文件格式" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Linux下ELF文件格式</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2015.09.13</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>feilengcui008</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/系统/">系统</a> / <a class="article-category-link" href="/categories/系统/编程语言/">编程语言</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
        <i class="icon-comment"></i> 
        <span class="ds-thread-count" data-thread-key="post-Linux下ELF文件格式"><i class="fa fa-spinner fa-spin"></i></span> 条评论
      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>In this article,I will talk about the ELF files for Linux,and their diffs as to comprehend the linking process in a diff view angle.There are many articles talking about that topic in the way of compiling-&gt;linking-&gt;loading-&gt;executing.I think once we understand the ELF files,then we can understand why and how and understand the whole process more precisely.  </p>
<p>ELF(Executable and Linkable Format) is the default file format of executable files,object files,shared object files and core file for Linux.Why should we know about the ELF?I think there are at least the following reasons:</p>
<ul>
<li>Guess what the back end of compilers(esp for c) wants to achieve(yeah,it’s “guess”,if you want to learn more about compilers,you should learn related theories more precisely)</li>
<li>Learn about the linking and loading process</li>
<li>Better understanding of the organization of our code,that’s helpful to debug and profiling(such the effects of static/local/global/extern,debug coredump file…)</li>
<li>guess how the OS loader loads the exec file to memory and run it(yeah,guess again^_^,I will analyze the loading process in some article later)</li>
<li>Better understanding of how the disk exec file mapped into memory space of process</li>
<li>…</li>
</ul>
<hr>
<p>I will choose the first three representative ELF files in Linux to analyze,that is the object files,executable files,and shared object files.Actually,the are very simmilar except some  differences(bacause they share elf struct which is defined in the elf.h^_^)</p>
<p>Here is the code used for the analysis purpose of this article(main.c and print.c):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.c </span></span><br><span class="line"><span class="comment">//note that we define diff kinds of vars so we can test where they are lied in within diff sections or segments,thus we can better understand the layout of c file</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main_global_unitialized;</span><br><span class="line"><span class="keyword">int</span> main_global_initialized = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> main_local_uninitialized;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> main_local_uninitialized = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print1</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print2</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> main_stack_uninitialized;</span><br><span class="line">    <span class="keyword">int</span> main_stack_initialized = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> main_func_local_uninitialized;</span><br><span class="line">    <span class="keyword">static</span> main_func_local_initialized = <span class="number">4</span>;</span><br><span class="line">    print(<span class="number">2</span>);</span><br><span class="line">    print1(<span class="number">2</span>);</span><br><span class="line">    print2(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print1</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%d\n"</span>, a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print2</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%d\n"</span>, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//print.c</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//in module vars</span></span><br><span class="line"><span class="keyword">int</span> print_global_uninitialized;</span><br><span class="line"><span class="keyword">int</span> print_global_initialized = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> print_local_static_uninitialized;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> print_local_static_initialized = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> print_stack_uninitialized;</span><br><span class="line">    <span class="keyword">int</span> print_stack_initialized = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> print_func_local_static_uninitialized;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> print_func_local_static_initialized = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%d\n"</span>, a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print2</span><span class="params">(<span class="keyword">int</span> a)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"%d\n"</span>, a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>We use the above two souce files to generate the following file:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gcc -o print<span class="class">.o</span> -c print<span class="class">.c</span></span><br><span class="line">gcc -o main<span class="class">.o</span> -c main<span class="class">.c</span></span><br><span class="line">gcc -shared -fPIC -o print<span class="class">.so</span> print<span class="class">.c</span></span><br><span class="line">gcc -o exec main<span class="class">.o</span> print<span class="class">.o</span></span><br><span class="line"><span class="comment">//and the tools we may use:</span></span><br><span class="line"><span class="comment">//readelf/objdump/nm/size...</span></span><br><span class="line"><span class="comment">//the platform is Linux tan 3.13.0-51-generic #84-Ubuntu SMP x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20150420101332687" alt="这里写图片描述"></p>
<hr>
<p>We will look into some diffs of the aboved mentioned 3 kinds of ELF files,we mainly use readelf.<br>Usually,ELF files (may) consists of the following parts:</p>
<ul>
<li>file headers: describe file info such as start point,section header start poit etc</li>
<li>program header table: info of mapping sections to segments</li>
<li>section header table: section entry info</li>
<li>sections: each section contents such as .data .text etc</li>
<li>…</li>
</ul>
<h3 id="1-file_headers"><a href="#1-file_headers" class="headerlink" title="1.file headers"></a>1.file headers</h3><h4 id="executable_file_headers_3A"><a href="#executable_file_headers_3A" class="headerlink" title="executable file headers:"></a>executable file headers:</h4><p><img src="http://img.blog.csdn.net/20150420103046089" alt="这里写图片描述"></p>
<h4 id="object_file_headers_3A"><a href="#object_file_headers_3A" class="headerlink" title="object file headers:"></a>object file headers:</h4><p><img src="http://img.blog.csdn.net/20150420103102329" alt="这里写图片描述"></p>
<h4 id="shared_object_file_headers_3A"><a href="#shared_object_file_headers_3A" class="headerlink" title="shared object file headers:"></a>shared object file headers:</h4><p><img src="http://img.blog.csdn.net/20150420103231405" alt="这里写图片描述"></p>
<p>As we can see,the file header of exec/.o/.so are almost the same except some options like type,start point…:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">define</span> EI_NIDENT <span class="number">16</span></span></span><br><span class="line">      <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">          <span class="comment">//magic number denotes the file,16 byte,for ELF:7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span></span><br><span class="line">          <span class="keyword">unsigned</span> <span class="keyword">char</span> e_ident[EI_NIDENT]; </span><br><span class="line">          <span class="comment">//ELF file type:exec/.o/.so/core/unknown</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_type;</span><br><span class="line">          <span class="keyword">uint16_t</span>      e_machine;</span><br><span class="line">          <span class="keyword">uint32_t</span>      e_version;</span><br><span class="line">          <span class="comment">//_start point of the program</span></span><br><span class="line">          Elf64_Addr     e_entry;</span><br><span class="line">          <span class="comment">//program header table offset,no for .o file</span></span><br><span class="line">          Elf64_Off      e_phoff;</span><br><span class="line">          <span class="comment">//section header table offset</span></span><br><span class="line">          Elf64_Off      e_shoff;</span><br><span class="line">          <span class="keyword">uint32_t</span>      e_flags;</span><br><span class="line">          <span class="comment">//header size</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_ehsize;</span><br><span class="line">          <span class="comment">//entry size for program header table</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_phentsize;</span><br><span class="line">          <span class="comment">//program entry numbers</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_phnum;</span><br><span class="line">          <span class="comment">//entry size for section header table</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_shentsize;</span><br><span class="line">          <span class="comment">//section entry number</span></span><br><span class="line">          <span class="keyword">uint16_t</span>      e_shnum;</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">uint16_t</span>      e_shstrndx;</span><br><span class="line">      &#125; Elf64_Ehdr;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Conclusions or diffs:</p>
<ul>
<li>type is different </li>
<li>no start point for .o file</li>
<li>no program header for .o file</li>
</ul>
</blockquote>
<hr>
<h3 id="2-section_header_table"><a href="#2-section_header_table" class="headerlink" title="2.section header table"></a>2.section header table</h3><h4 id="exec_file_section_header_table_3A"><a href="#exec_file_section_header_table_3A" class="headerlink" title="exec file section header table:"></a>exec file section header table:</h4><p><img src="http://img.blog.csdn.net/20150420123100072" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20150420123311384" alt="这里写图片描述"></p>
<h4 id="so_file_section_header_table_3A"><a href="#so_file_section_header_table_3A" class="headerlink" title=".so file section header table:"></a>.so file section header table:</h4><p><img src="http://img.blog.csdn.net/20150420123332990" alt="这里写图片描述"><br><img src="http://img.blog.csdn.net/20150420123344768" alt="这里写图片描述"></p>
<h4 id="o_file_section_header_table_3A"><a href="#o_file_section_header_table_3A" class="headerlink" title=".o file section header table:"></a>.o file section header table:</h4><p><img src="http://img.blog.csdn.net/20150420123311721" alt="这里写图片描述"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="keyword">uint32_t</span>   sh_name;<span class="comment">// section name</span></span><br><span class="line">	<span class="keyword">uint32_t</span>   sh_type;<span class="comment">//section type:RELA,STRTAB,SYMTAB...</span></span><br><span class="line">	<span class="keyword">uint64_t</span>   sh_flags;<span class="comment">//rwe...</span></span><br><span class="line">	Elf64_Addr sh_addr; <span class="comment">//virtual address(no for .o file)</span></span><br><span class="line">	Elf64_Off  sh_offset;</span><br><span class="line">	<span class="keyword">uint64_t</span>   sh_size;</span><br><span class="line">	<span class="keyword">uint32_t</span>   sh_link;</span><br><span class="line">	<span class="keyword">uint32_t</span>   sh_info;</span><br><span class="line">	<span class="keyword">uint64_t</span>   sh_addralign;<span class="comment">//address align </span></span><br><span class="line">	<span class="keyword">uint64_t</span>   sh_entsize;</span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Conclusions or diffs:</p>
<ul>
<li>the sections of exec file and .so file are almost the same</li>
<li>more sections in exec and .so file than .o file since some sections like .fini/.init_array/.fini_array/.got/.got.plt/.init … are added during linking process</li>
<li>the virtual address of every section in .o file is 0,but not in exec and .so file</li>
</ul>
</blockquote>
<hr>
<h3 id="3-program_header_table"><a href="#3-program_header_table" class="headerlink" title="3.program header table"></a>3.program header table</h3><h4 id="exec_file_program_header_3A"><a href="#exec_file_program_header_3A" class="headerlink" title="exec file program header:"></a>exec file program header:</h4><p><img src="http://img.blog.csdn.net/20150420125657897" alt="这里写图片描述"></p>
<h4 id="so_file_program_header_3A"><a href="#so_file_program_header_3A" class="headerlink" title=".so file program header:"></a>.so file program header:</h4><p><img src="http://img.blog.csdn.net/20150420125723482" alt="这里写图片描述"></p>
<h4 id="o_file_program_header_3A"><a href="#o_file_program_header_3A" class="headerlink" title=".o file program header:"></a>.o file program header:</h4><p><img src="http://img.blog.csdn.net/20150420125621933" alt="这里写图片描述"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">               <span class="keyword">uint32_t</span>   p_type; <span class="comment">//segment type</span></span><br><span class="line">               <span class="keyword">uint32_t</span>   p_flags; <span class="comment">//permission</span></span><br><span class="line">               Elf64_Off  p_offset; <span class="comment">// offset</span></span><br><span class="line">               Elf64_Addr p_vaddr; <span class="comment">//virtual address</span></span><br><span class="line">               Elf64_Addr p_paddr; <span class="comment">//phisical address</span></span><br><span class="line">               <span class="keyword">uint64_t</span>   p_filesz; <span class="comment">//size</span></span><br><span class="line">               <span class="keyword">uint64_t</span>   p_memsz;</span><br><span class="line">               <span class="keyword">uint64_t</span>   p_align;</span><br><span class="line">           &#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Conclusions or diffs:</p>
<ul>
<li>there is no program header for .o file</li>
<li>some sections are divided into one segment according to the permisson flag</li>
</ul>
</blockquote>
<hr>
<h3 id="4-common_sections_explain"><a href="#4-common_sections_explain" class="headerlink" title="4.common sections explain"></a>4.common sections explain</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.intern</span> </span><br><span class="line"><span class="id">#path</span> <span class="keyword">for</span> elf interpretor</span><br><span class="line"><span class="id">#here</span> is an <span class="tag">article</span> about changing the ld</span><br><span class="line"><span class="id">#http</span>:<span class="comment">//nixos.org/patchelf.html</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.dynsym</span></span><br><span class="line"><span class="id">#the</span> dynamic linking symbol table</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.dynstr</span></span><br><span class="line"><span class="id">#strings</span> needed <span class="keyword">for</span> dynamic linking</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.init</span></span><br><span class="line"><span class="id">#executable</span> instructions that contribute to the process initialization <span class="function"><span class="title">code</span><span class="params">(before main)</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.plt</span><br><span class="line">#<span class="function"><span class="keyword">procedure</span> <span class="title">linkage</span> <span class="title">table</span></span><br><span class="line">#<span class="title">for</span> <span class="title">GOT</span> <span class="title">dynamic</span> <span class="title">linker</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.text</span></span><br><span class="line"><span class="id">#executable</span> instructions of <span class="tag">a</span> program</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.fini</span></span><br><span class="line"><span class="id">#executable</span> instructions that contribute to the process termination code</span><br></pre></td></tr></table></figure>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.rodata</span><br><span class="line"># read-<span class="keyword">only</span> <span class="type">data</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.dynamic</span></span><br><span class="line"><span class="id">#dynamic</span> linking information</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.got</span></span><br><span class="line"><span class="id">#global</span> offset <span class="tag">table</span></span><br><span class="line"><span class="id">#for</span> dynamic linker to resolve global elements</span><br></pre></td></tr></table></figure>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="typedef"><span class="keyword">data</span></span></span><br><span class="line"><span class="preprocessor"># initialized data</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.bss</span></span><br><span class="line"><span class="id">#uninitialized</span> data</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.comment</span></span><br><span class="line"><span class="id">#version</span> control info</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.shstrtab</span></span><br><span class="line"><span class="id">#section</span> names</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.strtab</span></span><br><span class="line"><span class="id">#string</span> table</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.symtab</span></span><br><span class="line"><span class="id">#symble</span> table</span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">.debug</span></span><br><span class="line"><span class="hexcolor">#deb</span>ug info</span><br></pre></td></tr></table></figure>
<p>for C++:</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.ctors</span><br><span class="line">#initialized pointers <span class="keyword">to</span> the C++ <span class="function"><span class="keyword">constructor</span> <span class="title">functions</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.dtors</span><br><span class="line">#initialized pointers <span class="keyword">to</span> the C++ <span class="function"><span class="keyword">destructor</span> <span class="title">functions</span></span></span><br></pre></td></tr></table></figure>
<hr>
<h4 id="The_sections_contain_important_data_for_linking_and_relocation__2C_while_segments_contain_information_that_is_necessary_for_runtime_execution_of_the_file"><a href="#The_sections_contain_important_data_for_linking_and_relocation__2C_while_segments_contain_information_that_is_necessary_for_runtime_execution_of_the_file" class="headerlink" title="The sections contain important data for linking and relocation , while segments contain information that is necessary for runtime execution of the file."></a>The sections contain important data for linking and relocation , while segments contain information that is necessary for runtime execution of the file.</h4><p>About program header:<a href="http://www.sco.com/developers/gabi/latest/ch5.pheader.html" target="_blank" rel="external">http://www.sco.com/developers/gabi/latest/ch5.pheader.html</a><br>here is picture portraits the diff views for sections and segments:<br><img src="http://img.blog.csdn.net/20150420130748465" alt="这里写图片描述"></p>
<h3 id="5-code_mapped_into_sections"><a href="#5-code_mapped_into_sections" class="headerlink" title="5.code mapped into sections"></a>5.code mapped into sections</h3><p>In the last part we take a look at the symble table for our code in main.c and print.c and verify the scope of vars.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//get symble info <span class="operator"><span class="keyword">use</span> nm</span><br><span class="line">nm exec | egrep <span class="string">"main|print"</span></span><br><span class="line"><span class="comment">----------------------------</span></span><br><span class="line">the <span class="number">3</span> <span class="keyword">columns</span>:</span><br><span class="line"><span class="comment">--vaddress (dynamic linking is NULL)</span></span><br><span class="line"><span class="comment">--symble type and local or global</span></span><br><span class="line"><span class="number">1.</span>uppercase stands <span class="keyword">for</span> <span class="keyword">global</span>,lowercase <span class="keyword">is</span> <span class="keyword">local</span></span><br><span class="line"><span class="number">2.</span></span><br><span class="line">B|b:uninitialized(BSS)</span><br><span class="line"><span class="keyword">D</span>|<span class="keyword">d</span>:<span class="keyword">initialized</span> <span class="keyword">data</span> <span class="keyword">section</span></span><br><span class="line"><span class="keyword">T</span>|<span class="keyword">t</span>:<span class="built_in">text</span> (code) <span class="keyword">section</span></span><br><span class="line">R|r: <span class="keyword">read</span> <span class="keyword">only</span> <span class="keyword">data</span> <span class="keyword">section</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">--symble</span></span></span><br></pre></td></tr></table></figure>
<p><img src="http://img.blog.csdn.net/20150420135821837" alt="这里写图片描述"></p>
<blockquote>
<p>So we can check the symbles in main.c and print.c,you can find how the code and data are mapper to each sections,and then organized into segments when linked into executable elf files,so it can be easily loaded into memory(actually mapped) by the OS loader(to some extent we can think it’s execve syscall)</p>
</blockquote>
<h3 id="6_to_the_end"><a href="#6_to_the_end" class="headerlink" title="6 to the end"></a>6 to the end</h3><p>In all,I talk about the three parts of the elf files in Linux especially some diffs between exec,.so and .o files and the organization for sections and segments.<br>If you want to know more precisely about these topics,you can refer to the following materials:</p>
<blockquote>
<p>Ref:<br>some articles:<br><a href="http://man7.org/linux/man-pages/man5/elf.5.html（man" target="_blank" rel="external">http://man7.org/linux/man-pages/man5/elf.5.html（man</a> manual is so powerful^_^）<br><a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format" target="_blank" rel="external">https://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a><br><a href="http://www.sco.com/developers/gabi/latest/ch5.pheader.html" target="_blank" rel="external">http://www.sco.com/developers/gabi/latest/ch5.pheader.html</a><br><a href="http://tech.meituan.com/linker.html" target="_blank" rel="external">http://tech.meituan.com/linker.html</a><br>some books:<br>1.CSAPP<br>2.《程序员的自我修养》</p>
</blockquote>

    
  </div>
</article>


   

   



</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">Close</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/"
              rel="noopener noreferrer"
              target="_self"
              >
              Home
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              Archives
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              About
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="post-Linux下ELF文件格式" 
      data-title="Linux下ELF文件格式" data-url="/2015/09/13/Linux下ELF文件格式/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"feilengcui008"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
